{% extends 'inventario/base.html' %}

{% load static %}

{% block title %}Lista de Productos - Maestranzas Unidos S.A.{% endblock %}

{% block content %}

<h2 class="mb-4 mt-4 text-center text-black">Lista de Productos</h2>

<h5 class="mb-4 text-center text-black">Revisa la lista de productos aquí.</h5>

<div class="container my-4 px-0" style="max-width: 1650px; min-width: 800px;">
  <div class="card shadow" style="min-height: 520px;">
    <div class="card-body p-3">

      <!-- Filtros y botón agregar -->
      <form method="get" class="row g-3 align-items-center mb-3">
        <div class="col-sm-5 col-md-4">
          <select name="categoria" class="form-select form-select-sm" onchange="this.form.submit()" aria-label="Filtro categoría">
            <option value="">Todas las categorías</option>
            {% for cat in categorias %}
              <option value="{{ cat.id }}" {% if cat.id == categoria_seleccionada %}selected{% endif %}>{{ cat.nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-sm-5 col-md-4">
          <select name="bodega" class="form-select form-select-sm" style="min-width: 200px;" onchange="this.form.submit()" aria-label="Filtro bodega">
            <option value="">Todas las bodegas</option>
            {% for bod in bodegas %}
              <option value="{{ bod.id }}" {% if bod.id == bodega_seleccionada %}selected{% endif %}>{{ bod.nombre }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-auto">
          <a href="{% url 'producto_crud' %}" class="btn btn-outline-secondary btn-sm">Resetear</a>
        </div>

        {% with grupo=request.user.groups.first %}
          {% if grupo and grupo.name != 'Almacén' %}
            <div class="col-auto ms-auto">
              <button type="button" class="btn btn-dark btn-sm" data-bs-toggle="modal" data-bs-target="#modalMapaBodegas">
                Mapa de bodegas
              </button>
              <a href="{% url 'registro_producto' %}" class="btn btn-dark btn-sm">Agregar Producto</a>
            </div>
          {% endif %}
        {% endwith %}
      </form>

      <!-- Tabla con scroll horizontal compacto -->
      <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
        <table class="table table-bordered table-hover table-sm align-middle mb-0">
          <thead class="table-dark text-center">
            <tr>
              <th style="min-width: 220px;">Nombre</th>
              <th style="width: 80px;">Serie</th>
              <th style="width: 90px;">Cat.</th>
              <th style="min-width: 200px;">Bodega</th>
              <th style="width: 100px;">Precio</th>
              <th style="min-width: 180px;">Descripción</th>
              <th style="width: 100px;">Venc.</th>
              <th style="width: 80px;">Stock</th>
              <th style="width: 6rem;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for producto in productos %}
              <tr>
                <td>{{ producto.nombre }}</td>
                <td class="text-center"><span class="badge bg-dark">{{ producto.serial_number }}</span></td>
                <td class="text-center" title="{{ producto.categoria.nombre|default:'Sin categoría' }}">
                  {{ producto.categoria.nombre|truncatechars:10|default:"-" }}
                </td>
                <td>
                  {% with grupo=request.user.groups.first %}
                    {% if grupo and grupo.name != 'Almacén' %}
                      <form method="post" action="{% url 'cambiar_bodega' producto.id %}" class="d-flex align-items-center gap-2">
                        {% csrf_token %}
                        <select name="nueva_bodega" class="form-select form-select-sm" style="min-width: 190px;">
                          {% for b in bodegas %}
                            <option value="{{ b.id }}" {% if producto.bodega and producto.bodega.id == b.id %}selected{% endif %}>{{ b.nombre|truncatechars:14 }}</option>
                          {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-outline-secondary btn-sm px-2">OK</button>
                      </form>
                    {% else %}
                      <span style="display:inline-block; max-width: 190px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        {{ producto.bodega.nombre|truncatechars:16 }}
                      </span>
                    {% endif %}
                  {% endwith %}
                </td>
                <td class="text-end">${{ producto.precio }}</td>
                <td title="{{ producto.descripcion }}" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                  {{ producto.descripcion|truncatechars:25 }}
                </td>
                <td class="text-center">
                  {% if producto.fecha_vencimiento %}
                    {% if producto.fecha_vencimiento < today %}
                      <span class="badge bg-danger" title="Vencido">{{ producto.fecha_vencimiento|date:"d/m/Y" }}</span>
                    {% elif producto.fecha_vencimiento <= today_plus_7 %}
                      <span class="badge bg-warning text-dark" title="Por vencer">{{ producto.fecha_vencimiento|date:"d/m/Y" }}</span>
                    {% else %}
                      <span class="badge bg-success">{{ producto.fecha_vencimiento|date:"d/m/Y" }}</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  {% if producto.stock <= producto.stock_minimo %}
                    <span class="badge bg-danger" title="Stock bajo">{{ producto.stock }}</span>
                  {% else %}
                    <span class="badge bg-success">{{ producto.stock }}</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  {% with grupo=request.user.groups.first %}
                    {% if grupo and grupo.name != 'Almacén' %}
                      <a href="{% url 'editar_producto' producto.id %}" class="btn btn-secondary btn-sm" title="Editar"><i class="fas fa-edit"></i></a>
                      <a href="?delete={{ producto.id }}" class="btn btn-danger btn-sm" title="Eliminar" onclick="return confirm('¿Eliminar este producto?');"><i class="fas fa-trash"></i></a>
                    {% endif %}
                  {% endwith %}
                  <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#detalles{{ producto.id }}" aria-expanded="false" aria-controls="detalles{{ producto.id }}" title="Detalles">
                    <i class="fas fa-chevron-down"></i>
                  </button>
                </td>
              </tr>

              <!-- Modal -->
              <div class="modal fade" id="modalMapaBodegas" tabindex="-1" aria-labelledby="modalMapaBodegasLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="modalMapaBodegasLabel">Mapa de Bodegas</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">

                      <!-- Carrusel -->
                      <div id="carouselMapaBodegas" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner">

                          <div class="carousel-item active">
                            <img src="{% static 'inventario/img/bodega_A.png' %}" class="d-block w-100" alt="Imagen 1">
                            <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded">
                              <h5>Bodega A - Centro de Distribución Principal</h5>
                            </div>
                          </div>

                          <div class="carousel-item">
                            <img src="{% static 'inventario/img/1136160_7.webp' %}" class="d-block w-100" alt="Imagen 2">
                            <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded">
                              <h5>Título imagen 2</h5>
                            </div>
                          </div>

                          <div class="carousel-item">
                            <img src="{% static 'inventario/img/1136160_7.webp' %}" class="d-block w-100" alt="Imagen 3">
                            <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded">
                              <h5>Título imagen 3</h5>
                            </div>
                          </div>

                        </div>

                        <!-- Controles -->
                        <button class="carousel-control-prev" type="button" data-bs-target="#carouselMapaBodegas" data-bs-slide="prev">
                          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                          <span class="visually-hidden">Anterior</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#carouselMapaBodegas" data-bs-slide="next">
                          <span class="carousel-control-next-icon" aria-hidden="true"></span>
                          <span class="visually-hidden">Siguiente</span>
                        </button>

                        <!-- Indicadores -->
                        <div class="carousel-indicators">
                          <button type="button" data-bs-target="#carouselMapaBodegas" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Imagen 1"></button>
                          <button type="button" data-bs-target="#carouselMapaBodegas" data-bs-slide-to="1" aria-label="Imagen 2"></button>
                          <button type="button" data-bs-target="#carouselMapaBodegas" data-bs-slide-to="2" aria-label="Imagen 3"></button>
                        </div>
                      </div>

                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                  </div>
                </div>
              </div>

              
              <!-- Detalles ocultos, igual que antes -->

            {% empty %}
              <tr><td colspan="9" class="text-center text-muted">No hay productos para mostrar.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Paginación igual -->

    </div>
  </div>
</div>

{% endblock %}
